<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Government Primary School Pethgam Wagoora</title>

<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --brand:#0f62d0;
    --accent:#28a745;
    --muted:#6b7280;
    --card:#ffffff;
  }
  *{box-sizing:border-box}
  body{font-family:'Nunito',sans-serif;margin:0;background:#f3f8ff;color:#172b4d;line-height:1.3}

  /* Header */
  header.site-header{background:linear-gradient(90deg,var(--brand),#0b4fb0);color:#fff;padding:18px 14px;text-align:center;position:relative}
  .site-header .logo{width:84px;height:84px;border-radius:12px;object-fit:cover;border:3px solid rgba(255,255,255,0.18);display:block;margin:0 auto 8px}
  .site-header h1{margin:0;font-size:20px;font-weight:800}
  .site-header p.sub{margin:6px 0 0;font-size:13px;opacity:0.95}

  /* Top row - time & notifications */
  .top-row{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:8px 12px;background:#e9f1ff}
  .clock{font-weight:700;color:#063c8b}
  .notifications-scroll{flex:1;margin-left:12px;overflow:hidden;border-radius:8px;background:#fff;padding:6px 10px;box-shadow:0 2px 6px rgba(2,6,23,0.06)}
  .ticker{white-space:nowrap;display:inline-block;animation:scroll-left 18s linear infinite}
  @keyframes scroll-left{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}

  /* Menu */
  nav.menu{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:10px;background:#fff;border-bottom:1px solid #e6eefb}
  nav.menu a{display:inline-block;padding:10px 14px;background:linear-gradient(180deg,#ffffff,#e6f0ff);border-radius:10px;color:var(--brand);text-decoration:none;font-weight:700;box-shadow: 0 6px 0 rgba(10,60,150,0.12);transform:translateY(0);transition:transform .08s ease}
  nav.menu a:active{transform:translateY(3px);box-shadow:0 2px 0 rgba(10,60,150,0.08)}
  nav.menu .menu-logo{width:40px;height:40px;border-radius:8px;object-fit:cover;margin-right:8px;vertical-align:middle}

  /* Layout grid */
  .container{max-width:1100px;margin:18px auto;padding:0 12px;display:grid;grid-template-columns:1fr 320px;gap:18px}
  @media (max-width:900px){.container{grid-template-columns:1fr}}

  /* Main sections */
  .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(18,38,86,0.06)}
  .hero{display:flex;flex-direction:column;align-items:center;gap:10px;padding:22px;text-align:center}
  .hero h2{margin:6px 0 0;color:var(--brand)}
  .small{color:var(--muted);font-size:14px}

  /* admission card */
  .admission-card{max-width:420px;margin:10px auto;padding:18px;border-radius:12px;text-align:center}
  .btn-3d{display:inline-block;padding:12px 20px;border-radius:12px;background:linear-gradient(180deg,#1b75e6,#154fb2);color:#fff;font-weight:800;cursor:pointer;box-shadow:0 10px 0 rgba(8,45,110,0.15);border:none}
  .btn-3d:active{transform:translateY(6px);box-shadow:0 4px 0 rgba(8,45,110,0.08)}

  /* Student profile widget */
  .profile{display:flex;gap:12px;align-items:center}
  .profile img{width:86px;height:86px;border-radius:10px;object-fit:cover;border:4px solid #fff;box-shadow:0 6px 14px rgba(12,40,90,0.06)}
  .profile .meta{flex:1}

  /* right column - news vertical scroller */
  .right-column{position:relative;display:flex;flex-direction:column;gap:12px}
  .vertical-news{height:320px;overflow:hidden;border-radius:10px;background:linear-gradient(180deg,#fff,#f7fbff);padding:10px}
  .news-list{display:block;animation:scroll-up 18s linear infinite}
  .news-item{padding:8px 6px;border-bottom:1px dashed #e6eefb}
  @keyframes scroll-up{0%{transform:translateY(0)}50%{transform:translateY(-50%)}100%{transform:translateY(0)}}

  /* menu pages section placeholders */
  .grid-two{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}

  /* 2-column small list */
  .list-compact li{margin:6px 0}

  /* footer */
  footer{padding:18px;text-align:center;margin-top:18px;background:#eef6ff;border-top:1px solid #e1ecff}
  
  /* success message */
  .submitted{padding:14px;background:linear-gradient(180deg,#e9fff0,#d7fbe4);border-radius:10px;color:#087a3a;font-weight:800;text-align:center}

  /* small utilities */
  .muted{color:var(--muted);font-size:13px}
  .small{font-size:13px;color:var(--muted)}

</style>
</head>
<body>

<!-- Header -->
<header class="site-header">
  <img class="logo" src="https://pspathgam.github.io/ps-pethgam-wagoora/assets/images/school-logo.png.png" alt="School Logo">
  <h1>Government Primary School Pethgam Wagoora</h1>
  <p class="sub">Wagoora Babareshi Road ‚Äî Near Zonal Education Office</p>
</header>

<!-- Top row: clock + horizontal notifications -->
<div class="top-row">
  <div class="clock" id="liveClock">‚Äî</div>
  <div class="notifications-scroll">
    <div class="ticker" id="notifTicker">
      üì¢ Admissions Open | üóìÔ∏è Winter Vacation: 1 Dec ‚Äî 28 Feb | ‚ö†Ô∏è Check circulars for exam schedule | üéâ Children's Day programme on 14 Nov |
    </div>
  </div>
</div>

<!-- Menu -->
<nav class="menu">
  <img class="menu-logo" src="https://pspathgam.github.io/ps-pethgam-wagoora/assets/images/school-logo.png.png" alt="logo">
  <a href="index.html">Home</a>
  <a href="about.html">About</a>
  <a href="admission.html">Admissions</a>
  <a href="student-profile.html">Student Profile</a>
  <a href="examinations.html">Examinations</a>
  <a href="staff.html">Staff</a>
  <a href="circulars.html">Circulars & Orders</a>
  <a href="certificates.html">Certificates</a>
  <a href="contact.html">Contact</a>
</nav>

<!-- Main container -->
<div class="container">

  <!-- Left main column -->
  <main>

    <!-- Hero / Admission card -->
    <section class="card hero">
      <img src="https://pspathgam.github.io/ps-pethgam-wagoora/assets/images/school-logo.png.png" alt="logo" style="width:110px;border-radius:12px;display:block;margin:0 auto">
      <h2>Welcome to GPS Pethgam Wagoora</h2>
      <div class="small">Excellence in foundational education ‚Ä¢ Nursery to Grade 5</div>

      <div style="margin-top:14px" class="admission-card card">
        <h3 style="margin:0 0 6px">Online Admission ‚Äî 2025</h3>
        <div class="small">Apply online. Upload student photo. Download pre-filled admission PDF.</div>
        <div style="margin-top:12px">
          <button class="btn-3d" onclick="openForm()">Apply Now</button>
        </div>
      </div>
    </section>

    <!-- Student profile quick -->
    <section class="card" style="margin-top:14px">
      <h3>Student Profile</h3>
      <div class="profile">
        <img src="https://pspathgam.github.io/ps-pethgam-wagoora/assets/images/school-logo.png.png" alt="avatar">
        <div class="meta">
          <div style="font-weight:800">No student selected</div>
          <div class="muted">Use Student Profile page to view details or search by PEN</div>
        </div>
      </div>
    </section>

    <!-- Examinations / Quick links -->
    <section class="card" style="margin-top:14px">
      <h3>Quick Links</h3>
      <div class="grid-two">
        <div class="card small">
          <strong>Examinations</strong>
          <p class="small">FA1‚ÄìFA6 (5 marks each) ‚Ä¢ SA (50 marks)</p>
        </div>
        <div class="card small">
          <strong>Staff Profile</strong>
          <p class="small">View teacher details and contact</p>
        </div>
        <div class="card small">
          <strong>Circulars & Orders</strong>
          <p class="small">Important administrative circulars</p>
        </div>
        <div class="card small">
          <strong>Certificates</strong>
          <p class="small">Download bonafide, transfer, DOB certificates</p>
        </div>
      </div>
    </section>

  </main>

  <!-- Right column (news / events) -->
  <aside class="right-column">

    <div class="card vertical-news">
      <h4 style="margin:0 0 8px">News, Views & Events</h4>
      <div class="news-list" id="newsList">
        <div class="news-item"><strong>14 Nov</strong> - Children's Day celebration in school auditorium</div>
        <div class="news-item"><strong>01 Dec</strong> - Winter vacation begins</div>
        <div class="news-item"><strong>05 Jan</strong> - Parent Teacher Meeting (Class 1 & 2)</div>
        <div class="news-item"><strong>20 Feb</strong> - Annual Sports Day practice</div>
        <div class="news-item"><strong>28 Feb</strong> - School reopens</div>

        <!-- duplicated items to create continuous scroll -->
        <div class="news-item"><strong>14 Nov</strong> - Children's Day celebration in school auditorium</div>
        <div class="news-item"><strong>01 Dec</strong> - Winter vacation begins</div>
        <div class="news-item"><strong>05 Jan</strong> - Parent Teacher Meeting (Class 1 & 2)</div>
      </div>
    </div>

    <div class="card">
      <h4 style="margin-top:0">Notifications</h4>
      <ul class="list-compact">
        <li>üìå Admission forms available online</li>
        <li>üìå Upload documents: Aadhaar, DOB certificate</li>
        <li>üìå Contact school for admission timings</li>
      </ul>
    </div>

  </aside>
</div>

<!-- Footer -->
<footer>
  <div style="font-weight:800">Government Primary School Pethgam Wagoora</div>
  <div class="small">Wagoora Baberashi Road ‚Äî Near Zonal Education Office ‚Ä¢ Email: pspethgam@gmail.com</div>
</footer>

<!-- POPUP ‚Äî Two-page Admission Wizard -->
<div id="formPopup" role="dialog" aria-hidden="true">
  <div class="wizard card">

    <!-- LEFT: form pages -->
    <div class="left">
      <h3 id="wizardTitle">Admission Form ‚Äî Page 1 of 2</h3>

      <!-- PAGE 1 -->
      <div id="page1">
        <div class="row">
          <div>
            <label>Student Full Name (as per Aadhaar)</label>
            <input type="text" id="sname" placeholder="First Middle Last">
          </div>
          <div>
            <label>Father's Name</label>
            <input type="text" id="fname" placeholder="Father's full name">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Mother's Name</label>
            <input type="text" id="mname" placeholder="Mother's full name">
          </div>
          <div>
            <label>Gender</label>
            <select id="gender">
              <option value="">Select</option><option>Male</option><option>Female</option><option>Other</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Date of Birth</label>
            <input type="date" id="dob">
          </div>
          <div>
            <label>Place / Residence</label>
            <input type="text" id="residence" placeholder="Village / Address">
          </div>
        </div>

        <label>Tehsil / District</label>
        <div class="row">
          <div><input type="text" id="tehsil" placeholder="Tehsil"></div>
          <div><input type="text" id="district" placeholder="District"></div>
        </div>

        <label>Father's Contact Number</label>
        <input type="tel" id="contact" placeholder="10-digit mobile">

        <label>Aadhaar Number</label>
        <input type="text" id="aadhaar" placeholder="Optional">

        <div style="margin-top:8px;display:flex;gap:8px;">
          <button class="btn-ghost" onclick="closeForm()">Close</button>
          <div style="flex:1"></div>
          <button class="btn-3d" onclick="nextPage(2)">Next ‚Üí</button>
        </div>
      </div>

      <!-- PAGE 2 -->
      <div id="page2" style="display:none">
        <div class="row">
          <div>
            <label>Bank Account No.</label>
            <input type="text" id="bankacc">
          </div>
          <div>
            <label>IFSC Code</label>
            <input type="text" id="ifsc">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Category</label>
            <select id="category">
              <option>GENERAL</option><option>SC</option><option>ST</option><option>OBC</option>
            </select>
          </div>
          <div>
            <label>Blood Group</label>
            <input type="text" id="blood">
          </div>
        </div>

        <label>Ration Card Number / Type (if any)</label>
        <input type="text" id="ration">

        <label>Class Joining</label>
        <select id="joining">
          <option>Nursery</option><option>KG</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
        </select>

        <label>PEN (for transferring students)</label>
        <input type="text" id="pen">

        <label>Parent Declaration (short)</label>
        <textarea id="declaration">I declare that the information provided above is true to the best of my knowledge.</textarea>

        <label>Upload Photo (mobile gallery)</label>
        <input type="file" id="photoUpload" accept="image/*" onchange="handlePreview(event)">

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <div id="photoBox" class="preview"><span class="small muted">No photo</span></div>
          <div style="flex:1"></div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;">
          <button class="btn-ghost" onclick="nextPage(1)">‚Üê Back</button>
          <div style="flex:1"></div>
          <button class="btn-3d" onclick="submitAdmission()">Submit Now</button>
        </div>
      </div>

      <!-- After submission -->
      <div id="submittedBox" style="display:none;margin-top:12px">
        <div class="submitted">‚úî Form submitted successfully</div>
        <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
          <button class="btn-3d" onclick="generatePDF()">Download PDF</button>
          <button class="btn-ghost" onclick="closeForm()">Close</button>
        </div>
      </div>

    </div>

    <!-- RIGHT: sidebar preview + steps -->
    <aside class="right">
      <div style="padding:18px">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="width:64px;height:64px;border-radius:8px;overflow:hidden;background:#fff;display:flex;align-items:center;justify-content:center">
            <img id="previewLogo" src="https://pspathgam.github.io/ps-pethgam-wagoora/assets/images/school-logo.png.png" style="width:100%;height:100%;object-fit:cover">
          </div>
          <div>
            <div style="font-weight:800">Admission Form</div>
            <div class="small muted">Fill all required details carefully</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="steps">
            <div class="step active" id="step1">1 ‚Ä¢ Student Details</div>
            <div class="step" id="step2">2 ‚Ä¢ Family & Docs</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="small muted">Preview</div>
          <div style="margin-top:8px">
            <div class="preview" id="pdfPreviewArea">
              <div style="text-align:center">
                <div style="font-weight:800;color:var(--brand)">GPS Pethgam</div>
                <div class="small muted">Preview of PDF will include entered data</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </aside>

  </div>
</div>

<!-- scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* Live clock */
function updateClock(){
  const el=document.getElementById('liveClock');
  const d=new Date();
  const days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const day=days[d.getDay()];
  const date = d.toLocaleDateString();
  const time = d.toLocaleTimeString();
  el.textContent = `${day} ‚Ä¢ ${date} ‚Ä¢ ${time}`;
}
setInterval(updateClock,1000);
updateClock();

/* Wizard control */
function openForm(){
  document.getElementById('formPopup').style.display='flex';
  document.getElementById('formPopup').setAttribute('aria-hidden','false');
  showPage(1);
}
function closeForm(){
  document.getElementById('formPopup').style.display='none';
  document.getElementById('formPopup').setAttribute('aria-hidden','true');
}

/* navigate pages */
function showPage(n){
  document.getElementById('page1').style.display=(n===1?'block':'none');
  document.getElementById('page2').style.display=(n===2?'block':'none');
  document.getElementById('step1').classList.toggle('active', n===1);
  document.getElementById('step2').classList.toggle('active', n===2);
  document.getElementById('wizardTitle').innerText = `Admission Form ‚Äî Page ${n} of 2`;
}
function nextPage(n){
  showPage(n);
}

/* photo preview */
function handlePreview(e){
  const file = e.target.files[0];
  const box = document.getElementById('photoBox');
  if(!file) { box.innerHTML='<span class="small muted">No photo</span>'; return; }
  const reader = new FileReader();
  reader.onload = function(ev){
    box.innerHTML = `<img src="${ev.target.result}" style="width:100%;height:100%;object-fit:cover">`;
    // store dataURL for PDF
    box.dataset.img = ev.target.result;
  };
  reader.readAsDataURL(file);
}

/* simple validation and submit */
function submitAdmission(){
  // basic validation example
  const sname = document.getElementById('sname').value.trim();
  const fname = document.getElementById('fname').value.trim();
  const contact = document.getElementById('contact').value.trim();
  if(!sname || !fname){ alert('Please fill Student and Father name.'); return; }
  // show submitted UI
  document.getElementById('page1').style.display='none';
  document.getElementById('page2').style.display='none';
  document.getElementById('submittedBox').style.display='block';
}

/* generate two-page PDF using jsPDF */
async function generatePDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit:'pt', format:'a4' });
  const pageW = pdf.internal.pageSize.getWidth();
  const margin = 36;
  pdf.setFontSize(14);
  // --- Page 1 ---
  pdf.text('GOVERNMENT PRIMARY SCHOOL PETHGAM WAGOORA', pageW/2, 50, {align:'center'});
  pdf.setFontSize(11);
  let y = 90;
  function addLine(label, value){
    pdf.text(label, margin, y);
    pdf.text(String(value||''), margin+22}

.success-box {
    display: none;
    margin-top: 15px;
    padding: 10px;
    background: #d4f7d4;
    border-radius: 8px;
    color: #0b8c0b;
    font-weight: bold;
}

/* FOOTER */
footer {
    background: #1a73e8;
    color: white;
    padding: 15px;
    text-align: center;
    margin-top: 40px;
}
</style>

</head>
<body>

<header>
    <img src="https://raw.githubusercontent.com/pspathgam/ps-pethgam-wagoora/main/assets/images/school-logo.png" alt="School Logo">
    <h1>Government Primary School Pethgam Wagoora</h1>
    <p>Nursing to Grade 5 | Samagra Shiksha</p>
</header>

<!-- MENU -->
<nav class="menu">
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
    <a href="admission.html">Admissions</a>
    <a href="staff.html">Staff</a>
    <a href="gallery.html">Gallery</a>
    <a href="contact.html">Contact</a>
</nav>

<!-- ABOUT -->
<section class="section">
    <h2>About Our School</h2>
    <div class="about-card">
        Government Primary School Pethgam Wagoora provides child-friendly, joyful, 
        activity-based learning for all students from Nursery to Grade 5.
    </div>
</section>

<!-- ADMISSION CARD -->
<section class="section">
    <h2>üìò Online Admission ‚Äì 2025</h2>

    <div class="admission-card">
        <h3>New Admission</h3>
        <p>Fill the form online, upload photo & download PDF.</p>
        <div class="btn" onclick="openForm()">Apply Now</div>
    </div>
</section>

<!-- POPUP FORM -->
<div id="formPopup">
  <div class="form-box">

    <div class="close-btn" onclick="closeForm()">‚úñ</div>

    <h3>Admission Form</h3>

    <input id="studentName" type="text" placeholder="Student Name">
    <input id="fatherName" type="text" placeholder="Father Name">
    <input id="motherName" type="text" placeholder="Mother Name">
    <input id="dob" type="text" placeholder="Date of Birth (DD/MM/YYYY)">
    <input id="contact" type="text" placeholder="Parent Contact Number">

    <label>Upload Photo</label>
    <input id="photoUpload" type="file" accept="image/*">

    <div class="btn" onclick="submitForm()">Submit</div>

    <div class="success-box" id="successBox">
      ‚úî Submitted Successfully  
      <div class="btn" onclick="generatePDF()">Download PDF</div>
    </div>

  </div>
</div>

<footer>
    ¬© 2025 Government Primary School Pethgam Wagoora
</footer>

<!-- SCRIPT -->
<script>
function openForm() {
    document.getElementById("formPopup").style.display = "flex";
}

function closeForm() {
    document.getElementById("formPopup").style.display = "none";
}

function submitForm() {
    document.getElementById("successBox").style.display = "block";
}

function generatePDF() {
    alert("PDF Download will be added later.");
}
</script>
<script>
/* SAFE WIZARD & POPUP CONTROLS - drop into the end of index.html BEFORE </body> */

/* Helper: safe console wrapper */
const safeLog = (...args) => { try { console.log(...args); } catch(e){} };

/* Ensure popup element exists */
const POPUP_ID = 'formPopup';
function getPopup(){ return document.getElementById(POPUP_ID); }

/* Make sure buttons inside popup do not accidentally submit any forms */
function normalizePopupButtons() {
  const pop = getPopup();
  if(!pop) return;
  // convert <button> without type to type="button"
  pop.querySelectorAll('button').forEach(b => {
    if(!b.getAttribute('type')) b.setAttribute('type','button');
  });
  // also ensure clickable areas accept pointer events
  pop.style.pointerEvents = 'auto';
  const wizard = pop.querySelector('.wizard');
  if(wizard) wizard.style.pointerEvents = 'auto';
}

/* Open popup and reset view */
function openForm() {
  const pop = getPopup();
  if(!pop) { safeLog('openForm: popup not found'); return; }
  pop.style.display = 'flex';
  pop.setAttribute('aria-hidden','false');
  showPage(1);
  normalizePopupButtons();
  safeLog('Popup opened.');
}

/* Close popup */
function closeForm() {
  const pop = getPopup();
  if(!pop) { safeLog('closeForm: popup not found'); return; }
  pop.style.display = 'none';
  pop.setAttribute('aria-hidden','true');
  safeLog('Popup closed.');
}

/* Show a page number (1 or 2) */
function showPage(n) {
  const p1 = document.getElementById('page1');
  const p2 = document.getElementById('page2');
  if(p1) p1.style.display = (n===1 ? 'block' : 'none');
  if(p2) p2.style.display = (n===2 ? 'block' : 'none');
  // steps UI
  const s1 = document.getElementById('step1'), s2 = document.getElementById('step2');
  if(s1) s1.classList.toggle('active', n===1);
  if(s2) s2.classList.toggle('active', n===2);
  const title = document.getElementById('wizardTitle');
  if(title) title.innerText = `Admission Form ‚Äî Page ${n} of 2`;
  safeLog('Showing page', n);
}

/* Next/back navigation (exposed to inline onclick if present) */
function nextPage(n) { showPage(n); }

/* Photo preview helper for page 2 file input */
function handlePreview(e) {
  try {
    const file = e.target.files && e.target.files[0];
    const box = document.getElementById('photoBox');
    if(!box) return;
    if(!file) { box.innerHTML = '<span class="small muted">No photo</span>'; delete box.dataset.img; return; }
    const reader = new FileReader();
    reader.onload = function(ev) {
      box.innerHTML = `<img src="${ev.target.result}" style="width:100%;height:100%;object-fit:cover">`;
      box.dataset.img = ev.target.result; // store dataURL for PDF
    };
    reader.readAsDataURL(file);
  } catch(err) {
    safeLog('handlePreview error', err);
  }
}

/* Submit the admission form (basic validation) */
function submitAdmission() {
  try {
    const sname = (document.getElementById('sname')||{value:''}).value.trim();
    const fname = (document.getElementById('fname')||{value:''}).value.trim();
    if(!sname || !fname) { alert('Please enter Student name and Father name.'); return; }
    // hide pages, show submitted box
    const p1 = document.getElementById('page1'), p2 = document.getElementById('page2'), sub = document.getElementById('submittedBox');
    if(p1) p1.style.display = 'none';
    if(p2) p2.style.display = 'none';
    if(sub) sub.style.display = 'block';
    safeLog('Form submitted (UI only).');
  } catch(err) {
    safeLog('submitAdmission error', err);
    alert('An error occurred. Please try again.');
  }
}

/* Generate 2-page PDF using jsPDF (uses stored photo in #photoBox dataset.img) */
async function generatePDF(){
  try {
    if(!window.jspdf || !window.jspdf.jsPDF) {
      alert('PDF library not loaded yet. Try again in a moment.');
      return;
    }
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit:'pt', format:'a4' });
    const pageW = pdf.internal.pageSize.getWidth();
    const margin = 36;
    pdf.setFontSize(14);
    // Page 1 content
    pdf.text('GOVERNMENT PRIMARY SCHOOL PETHGAM WAGOORA', pageW/2, 50, { align:'center' });
    pdf.setFontSize(11);
    let y = 90;
    function line(a,b){ pdf.text(a, margin, y); pdf.text(String(b||''), margin+220, y); y+=18; }
    line('Student Name:', document.getElementById('sname')?.value);
    line('Father Name:', document.getElementById('fname')?.value);
    line('Mother Name:', document.getElementById('mname')?.value);
    line('DOB:', document.getElementById('dob')?.value);
    line('Contact:', document.getElementById('contact')?.value);
    line('Tehsil:', document.getElementById('tehsil')?.value);
    // add photo if present
    const box = document.getElementById('photoBox');
    const dataUrl = box && box.dataset && box.dataset.img;
    if(dataUrl){
      pdf.addImage(dataUrl, 'JPEG', pageW - margin - 140, 100, 120, 160);
    }
    // signature lines
    const footerY = pdf.internal.pageSize.getHeight() - 120;
    pdf.text('Parent Signature', margin, footerY);
    pdf.text('Head of Institution', pageW - margin - 180, footerY);
    pdf.line(margin, footerY+6, margin+180, footerY+6);
    pdf.line(pageW - margin - 220, footerY+6, pageW - margin - 20, footerY+6);
    // Page 2: consent text
    pdf.addPage();
    pdf.setFontSize(14);
    pdf.text('APAAR Consent & Declaration', pageW/2, 50, { align:'center' });
    pdf.setFontSize(11);
    const paragraphs = [
      'I hereby declare that the information provided above is true to the best of my knowledge.',
      'I consent to provide Aadhaar and demographic information for APAAR ID generation and DigiLocker account opening for my child.',
      'I understand UIDAI may use Aadhaar for e-KYC authentication and share the response with the Ministry of Education on successful authentication.'
    ];
    let ty = 100;
    paragraphs.forEach(p=>{
      const lines = pdf.splitTextToSize(p, pageW - margin*2);
      pdf.text(lines, margin, ty);
      ty += lines.length * 16 + 6;
    });
    pdf.save('Admission_GPS_Pethgam.pdf');
  } catch(e){
    safeLog('generatePDF error', e);
    alert('Unable to generate PDF right now.');
  }
}
function generateAdmissionPDF(){ generatePDF(); } // compatibility

/* Attach handlers for any inline-less buttons (safe attach) */
function attachPopupHandlers(){
  const pop = getPopup();
  if(!pop) return;
  // wire any elements with data-action attribute (if present)
  pop.querySelectorAll('[data-action]').forEach(el=>{
    const act = el.getAttribute('data-action');
    el.addEventListener('click', function(ev){
      ev.preventDefault();
      if(act === 'next') nextPage(Number(el.dataset.page||2));
      else if(act === 'back') nextPage(Number(el.dataset.page||1));
      else if(act === 'submit') submitAdmission();
      else if(act === 'close') closeForm();
      else if(act === 'open') openForm();
    });
  });
  // wire file input preview if exists
  const file = pop.querySelector('#photoUpload');
  if(file) file.removeEventListener('change', handlePreview);
  if(file) file.addEventListener('change', handlePreview);
}

/* Initialize: called once DOM is ready */
function initPopupFix() {
  try {
    // make sure popup exists
    if(!getPopup()){
      safeLog('initPopupFix: popup element not found in DOM yet.');
    } else {
      normalizePopupButtons();
      attachPopupHandlers();
      safeLog('initPopupFix: handlers attached.');
    }
  } catch(err) {
    safeLog('initPopupFix error', err);
  }
}

/* Run init after a short delay so DOM is parsed (safe) */
setTimeout(initPopupFix, 250);

/* Also run on DOMContentLoaded to be safe */
document.addEventListener('DOMContentLoaded', initPopupFix);

/* allow Esc to close popup */
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeForm(); });

</script>
</body>
</html>
